---
title: "`r params$doc_title`"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    css: style.css
    source_code: https://github.com/bcgov/Industry_Trades_Authority
params:
  doc_title: "Forecasts of Industry Trade Authority new apprenticeship registrations"
---

```{r}
library(flexdashboard)
library(knitr)
library(tidyverse)
library(DT)
library(plotly)
library(here)
theme_set(theme_grey(base_size = 15))
#functions--------------
plot_casts <- function(tbbl){
  ggplot()+
    geom_vline(xintercept = max_year+1, col="white", lwd=2)+
    geom_line(data=tbbl|>filter(!name %in% c("New Registrations", "prop_mean")),
              mapping=aes(year,
                          value,
                          group = name,
                          text=paste0(if_else(year<=max_year,"The backcast in ", "The forecast in "),
                          year,
                          if_else(year <= max_year, " was ", " is "),
                          scales::comma(value, accuracy = 1),
                          " based on ",
                          str_sub(name, -4),
                          " proportion.")
                          ),
              alpha=.1, 
              colour="red")+
    geom_line(data=tbbl|>filter(name =="New Registrations"),
              mapping=aes(year,
                          value,
                          group = name,
                          text=paste0("New registrations in ",
                          year,
                          " were ",
                          scales::comma(value))))+
    geom_line(data=tbbl|>filter(name =="prop_mean"),
              mapping=aes(year,
                          value,
                          group = name,
                          text=paste0(if_else(year<=max_year,"The backcast in ", "The forecast in "),
                          year, 
                          if_else(year <= max_year, " was ", " is "),
                          scales::comma(value, accuracy = 1),
                          " based on the mean proportion (2016:",
                          max_year,
                          ")")),
              colour="red")+
    scale_y_continuous(labels = scales::comma)+
    labs(x=NULL,
         y=NULL)
}

#load dataframes-------------------
fcast_tbbl <- read_rds(here("processed_data","fcast_tbbl.RDS"))
fcast_long <- read_rds(here("processed_data","fcast_long.RDS"))

max_year <- fcast_tbbl|>
  filter(!is.na(`New Registrations`))|>
  slice_max(year, with_ties = FALSE)|>
  pull(year)|>
  as.numeric()

page_titles <- c("Title Page",#replace with your page titles
                 "Methodology",
                 "All groups, British Columbia",
                 "All groups, by region",
                 "Skilled Trades Certification (STC), BC",
                 "Skilled Trades Certification (STC), by region",
                 "British Columbia, by group",
                 "Lower Mainland Southwest",
                 "Vancouver Island and Coast",
                 "South East",
                 "North",
                 "Data table"
                 )

```

# `r page_titles[1]` {data-navmenu="Table of Contents"}

## Row {data-height="400"}

```{r, out.width = "100%"}
knitr::include_graphics("psfs.png")#the cover image
```

## Row {data-height="600"}

### 

<h1 class="center">

`r params$doc_title`.

</h1>

# `r page_titles[2]` {data-navmenu="Table of Contents"}

## Row  {data-height="1000"}

```{r}
# for methodology explanation.
fcast_tbbl%>%
  filter(drname=="British Columbia",
         group=="All groups")%>%
   DT::datatable(
    rownames = FALSE,
    escape = FALSE,
    extensions = c('Buttons', 'FixedColumns'),
    class = 'cell-border stripe',
    options = list(
    dom = 't',
    scrollX = TRUE))
```

## Row

### Methodology

*  For example, consider the data above (all trades groups for British Columbia).
*  **New Registrations ** is the aggregate value of new registrations for a given **year**, **drname** and **group**. 
*  Note that for the (likely incomplete) last year of data, New Registrations is 12 times the year-to-date monthly average.
*   **employment** is from the LFS up to `r max_year-1`, and from the LMO forecast for `r max_year` onwards.
*   **prop_year** : we use the historic relationship between new registrations and employment in the given year, and apply it to future levels of employment.
*   **prop_mean**: same as above, but proportion is based on all years between 2016 and `r max_year`.
*   **scaled_up** the monthly average of New Registrations for the current year times 12.

# `r page_titles[3]` {data-navmenu="Table of Contents"}

## Column

### New registrations for `r page_titles[3]` (black) and fore/back-casts (red). 

```{r fig.width=16, fig.height=8}
total <- fcast_long%>%
  filter(drname=="British Columbia",
         group=="All groups")
plot_casts(total)|>
  plotly::ggplotly(tooltip = "text")
```

# `r page_titles[4]` {data-navmenu="Table of Contents"}

## Column

### New registrations for `r page_titles[4]` (black) and fore/back-casts (red). 

```{r fig.width=16, fig.height=8}
by_region <- fcast_long%>%
  filter(group=="All groups",
         drname!="British Columbia",
         drname!="NULL")

plt <- plot_casts(by_region)+
    facet_wrap(~fct_reorder(drname, value, .desc = TRUE), scales = "free_y")

plotly::ggplotly(plt, tooltip = "text")
```

# `r page_titles[5]` {data-navmenu="Table of Contents"}

## Column

### New registrations for `r page_titles[5]` (black) and fore/back-casts (red). 

```{r fig.width=16, fig.height=8}
by_region <- fcast_long%>%
  filter(group=="STC Trades",
         drname=="British Columbia")
plt <- plot_casts(by_region)+
    facet_wrap(~fct_reorder(drname, value, .desc = TRUE), scales = "free_y")

plotly::ggplotly(plt, tooltip = "text")
```

# `r page_titles[6]` {data-navmenu="Table of Contents"}

## Column

### New registrations for `r page_titles[6]` (black) and fore/back-casts (red). 

```{r fig.width=16, fig.height=8}
by_region <- fcast_long%>%
  filter(group=="STC Trades",
         drname!="British Columbia",
         drname!="NULL")
plt <- plot_casts(by_region)+
    facet_wrap(~fct_reorder(drname, value, .desc = TRUE), scales = "free_y")

plotly::ggplotly(plt, tooltip = "text")
```


# `r page_titles[7]` {data-navmenu="Table of Contents"}

## Column

### New registrations for `r page_titles[7]` (black) and fore/back-casts (red). 

```{r fig.width=16, fig.height=8}
bc_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="British Columbia")
plt <- plot_casts(bc_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free")

plotly::ggplotly(plt, tooltip = "text")
```

# `r page_titles[8]` {data-navmenu="Table of Contents"}

## Column

### New registrations for `r page_titles[8]` (black) and fore/back-casts (red). 

```{r fig.width=16, fig.height=8}
lml_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="Mainland South West")
plt <- plot_casts(lml_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free_y")

plotly::ggplotly(plt, tooltip = "text")
```

# `r page_titles[9]` {data-navmenu="Table of Contents"}

## Column

### New registrations for `r page_titles[9]` (black) and fore/back-casts (red). 

```{r fig.width=16, fig.height=8}
island_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="Vancouver Island Coast")
plt <-   plot_casts(island_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free_y")

plotly::ggplotly(plt, tooltip = "text")
```

# `r page_titles[10]` {data-navmenu="Table of Contents"}

## Column

### New registrations for `r page_titles[10]` (black) and fore/back-casts (red). 

```{r fig.width=16, fig.height=8}
south_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="Southeast")
plt <-   plot_casts(south_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free_y")

plotly::ggplotly(plt, tooltip = "text")
```

# `r page_titles[11]` {data-navmenu="Table of Contents"}

## Column

### New registrations for `r page_titles[11]` (black) and fore/back-casts (red). 

```{r fig.width=16, fig.height=8}
north_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="North")
plt <-   plot_casts(north_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free_y")

plotly::ggplotly(plt, tooltip = "text")
```

# `r page_titles[12]` {data-navmenu="Table of Contents"}

## Column

### Click &darr; to download data

```{r}
fcast_tbbl %>%
  DT::datatable(
    rownames = FALSE,
    escape = FALSE,
    extensions = c('Buttons', 'FixedColumns'),
    class = 'cell-border stripe',
    options = list(
    pageLength = 100,
    dom = 'Bfrtip',
    scrollX = TRUE,
    buttons = c('csv', 'excel')))
```
