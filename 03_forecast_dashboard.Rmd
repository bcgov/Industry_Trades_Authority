---
title: "`r params$doc_title`"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    css: style.css
    source_code: https://github.com/bcgov/Industry_Trades_Authority
params:
  doc_title: "Forecasts of Industry Trade Authority new apprenticeship registrations"
---

```{r}
library(flexdashboard)
library(knitr)
library(tidyverse)
library(DT)
library(plotly)
library(here)
theme_set(theme_grey(base_size = 15))
#functions--------------
plot_casts <- function(tbbl){
    tbbl|>
    ggplot(aes(year, value, colour=name, linetype=name))+
    annotate(geom = "rect",
             xmin = c(2016, 2021),
             xmax = c(2019, 2024),
             ymin = -Inf,
             ymax = +Inf,
             alpha = 0.2) +
    geom_line()+
    scale_linetype_manual(values = c(rep(1, 3), 2))+
    facet_wrap(~fct_reorder(group, -value), scales = "free")+
    scale_y_continuous(labels = scales::comma)+
    labs(x=NULL, 
         y=NULL,
         colour="Series",
         linetype="Series"
    )
    
}
#load dataframes-------------------
fcast_tbbl <- read_rds(here("processed_data","fcast_tbbl.RDS"))
fcast_long <- read_rds(here("processed_data","fcast_long.RDS"))

max_year <- fcast_tbbl|>
  filter(!is.na(`New Registrations`))|>
  slice_max(year, with_ties = FALSE)|>
  pull(year)|>
  as.numeric()

page_titles <- c("Title Page",#replace with your page titles
                 "Methodology",
                 "All groups, British Columbia",
                 "All groups, by region",
                 "Skilled Trades Certification (STC), BC",
                 "Skilled Trades Certification (STC), by region",
                 "British Columbia, by group",
                 "Lower Mainland Southwest",
                 "Vancouver Island and Coast",
                 "South East",
                 "North",
                 "Data table"
                 )

```

# `r page_titles[1]` {data-navmenu="Table of Contents"}

## Row {data-height="400"}

```{r, out.width = "100%"}
knitr::include_graphics("psfs.png")#the cover image
```

## Row {data-height="600"}

### 

<h1 class="center">

`r params$doc_title`.

</h1>

# `r page_titles[2]` {data-navmenu="Table of Contents"}

## Row  {data-height="700"}

```{r}
# for methodology explanation.
fcast_tbbl%>%
  filter(drname=="British Columbia",
         group=="All groups")%>%
  mutate(across(`2016:2019 ratio`:`both period ratio`, ~ round(.x, 4)),
         across(`New Registrations`:employment, ~ round(.x))
         )|>
   DT::datatable(
    rownames = FALSE,
    escape = FALSE,
    extensions = c('Buttons', 'FixedColumns'),
    class = 'cell-border stripe',
    options = list(
    dom = 't',
    scrollX = TRUE))
```

## Row

### Methodology

*  For example, consider the data above (all trades groups for British Columbia).
*  **New Registrations ** is the aggregate value of new registrations for a given **year**, **drname** and **group**. 
*  Note that for the (likely incomplete) last year of data, New Registrations is 12 times the year-to-date monthly average.
*   **employment** is from the LFS up to 2023, and from the LMO forecast for 2024 onwards.
*   **2016:2019 ratio** is $\frac{\sum \mbox{New Registrations}}{\sum \mbox{employment}}$ for the years 2016, 2017, 2018, 2019.
*   **2021:2024 ratio** is $\frac{\sum \mbox{New Registrations}}{\sum \mbox{employment}}$ for the years 2021, 2022, 2023, 2024.
*   **both period ratio** is $\frac{\sum \mbox{New Registrations}}{\sum \mbox{employment}}$ for the years 2016, 2017, 2018, 2019, 2021, 2022, 2023, 2024.
*   **scaled_up** the monthly average of New Registrations for the current year times 12.
*   **based on 2016:2019 ratio** is a weighted average of employment times 2016:2019 ratio and scaled_up
*   **based on 2021:2024 ratio** is a weighted average of employment times 2021:2023 ratio and scaled_up
*   **based on both periods** is a weighted average of employment times both period ratio and scaled_up

# `r page_titles[3]` {data-navmenu="Table of Contents"}

## Column

### 

```{r fig.width=16, fig.height=8}
total <- fcast_long%>%
  filter(drname=="British Columbia",
         group=="All groups")
plot_casts(total)+
    labs(title="British Columbia / All trades groups")
```

# `r page_titles[4]` {data-navmenu="Table of Contents"}

## Column

### 

```{r fig.width=16, fig.height=8}
by_region <- fcast_long%>%
  filter(group=="All groups",
         drname!="British Columbia",
         drname!="NULL")

plot_casts(by_region)+
    facet_wrap(~fct_reorder(drname, value, .desc = TRUE), scales = "free_y")+
    labs(title="All trades groups by region")
```

# `r page_titles[5]` {data-navmenu="Table of Contents"}

## Column

### 

```{r fig.width=16, fig.height=8}
by_region <- fcast_long%>%
  filter(group=="STC Trades",
         drname=="British Columbia")
plot_casts(by_region)+
    facet_wrap(~fct_reorder(drname, value, .desc = TRUE), scales = "free_y")+
    labs(title="Skilled Trades Certification (STC), BC")
```

# `r page_titles[6]` {data-navmenu="Table of Contents"}

## Column

### 

```{r fig.width=16, fig.height=8}
by_region <- fcast_long%>%
  filter(group=="STC Trades",
         drname!="British Columbia",
         drname!="NULL")
plot_casts(by_region)+
    facet_wrap(~fct_reorder(drname, value, .desc = TRUE), scales = "free_y")+
    labs(title="Skilled Trades Certification (STC), by region")
```


# `r page_titles[7]` {data-navmenu="Table of Contents"}

## Column

### 

```{r fig.width=16, fig.height=8}
bc_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="British Columbia")
plot_casts(bc_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free")+
    labs(title="British Columbia by trades groups")
```

# `r page_titles[8]` {data-navmenu="Table of Contents"}

## Column

### 

```{r fig.width=16, fig.height=8}
lml_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="Mainland South West")
plot_casts(lml_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free_y")+
    labs(title="Lower Mainland Southwest by trades groups")
```

# `r page_titles[9]` {data-navmenu="Table of Contents"}

## Column

### 

```{r fig.width=16, fig.height=8}
island_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="Vancouver Island Coast")
  plot_casts(island_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free_y")+
    labs(title="Vancouver Island and Coast by trades groups")
```

# `r page_titles[10]` {data-navmenu="Table of Contents"}

## Column

### 

```{r fig.width=16, fig.height=8}
south_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="Southeast")
  plot_casts(south_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free_y")+
    labs(title="Southeast by trades groups")
```

# `r page_titles[11]` {data-navmenu="Table of Contents"}

## Column

### 

```{r fig.width=16, fig.height=8}
north_by_group <- fcast_long%>%
  filter(group!="All groups",
         group!="STC Trades",
         drname=="North")
  plot_casts(north_by_group)+
    facet_wrap(~fct_reorder(group, value, .desc = TRUE), scales = "free_y")+
    labs(title="North by trades groups")
```

# `r page_titles[12]` {data-navmenu="Table of Contents"}

## Column

### Click &darr; to download data

```{r}
fcast_tbbl %>%
   mutate(across(`2016:2019 ratio`:`both period ratio`, ~ round(.x, 4)),
         across(`New Registrations`:employment, ~ round(.x))
         )|>
  DT::datatable(
    rownames = FALSE,
    escape = FALSE,
    extensions = c('Buttons', 'FixedColumns'),
    class = 'cell-border stripe',
    options = list(
    pageLength = 100,
    dom = 'Bfrtip',
    scrollX = TRUE,
    buttons = c('csv', 'excel')))
```
